<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PARKFACIL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f5f7fa}
.layout{display:flex;min-height:100vh}
.sidebar{width:240px;background:#0f172a;color:#fff}
.brand{padding:16px;font-size:18px;border-bottom:1px solid #334155}
.menu div{padding:14px 16px;cursor:pointer}
.menu div:hover{background:#1e293b}
.content{flex:1;padding:24px}
.seccion{display:none;max-width:900px}
.seccion.activa{display:block}
.card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.1)}
input,select,button{width:100%;padding:10px;margin-top:8px}
button{border:none;border-radius:6px;color:#fff;cursor:pointer}
.azul{background:#2563eb}
.rojo{background:#dc2626}
.verde{background:#16a34a}
.gris{background:#6b7280}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left}
.badge{padding:4px 8px;border-radius:6px;font-size:12px}
.ok{background:#16a34a;color:#fff}
.block{background:#dc2626;color:#fff}
</style>
</head>

<body>
<div class="layout">

<div class="sidebar">
  <div class="brand">PARKFACIL</div>
  <div class="menu">
    <div onclick="show('login')">üîë Login</div>
    <div onclick="show('operacion')">üöó Operaci√≥n</div>
    <div onclick="show('operadores')">üë§ Operadores</div>
  </div>
</div>

<div class="content">

<!-- LOGIN -->
<div id="login" class="seccion activa">
  <div class="card">
    <h3>Ingreso al sistema</h3>
    <input id="loginUser" placeholder="Usuario">
    <input id="loginPass" type="password" placeholder="Clave">
    <button class="verde" onclick="login()">Ingresar</button>
    <div id="loginMsg"></div>
  </div>
</div>

<!-- OPERACION -->
<div id="operacion" class="seccion">
  <div class="card">
    <h3>Operaci√≥n</h3>
    <div id="sectorActivo" class="badge"></div>
    <input id="patente" placeholder="CX-PY-95">
    <button class="azul" onclick="iniciar()">Iniciar estad√≠a</button>
    <button class="rojo" onclick="detener()">Detener estad√≠a</button>
    <div id="resultado"></div>
    <div id="qr"></div>
  </div>
</div>

<!-- OPERADORES -->
<div id="operadores" class="seccion">
  <div class="card">
    <h3>Gesti√≥n de Operadores (Admin)</h3>
    <input id="opNombre" placeholder="Nombre">
    <input id="opApellido" placeholder="Apellido">
    <input id="opCorreo" placeholder="Correo">
    <input id="opTelefono" placeholder="Tel√©fono m√≥vil">
    <input id="opUsuario" placeholder="Usuario">
    <input id="opClave" type="password" placeholder="Clave">
    <select id="opRol">
      <option value="operador">Operador</option>
      <option value="admin">Admin</option>
    </select>
    <select id="opSector"></select>
    <button class="verde" onclick="crearOperador()">Agregar operador</button>
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Rol</th>
          <th>Sector</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaOps"></tbody>
    </table>
  </div>
</div>

</div>
</div>

<script>
// HELPERS
const g=k=>JSON.parse(localStorage.getItem(k)||'[]');
const s=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

// INIT DATA
if(!g('sectores').length){
  s('sectores',[
    {id:1,n:'Sector A'},
    {id:2,n:'Sector B'}
  ]);
}
if(!g('ops').length){
  s('ops',[
    {id:1,n:'Admin Principal',usuario:'admin',clave:'admin123',rol:'admin',sector:1,activo:true}
  ]);
}

let operadorActivo = null;

// NAV
function show(id){
  document.querySelectorAll('.seccion').forEach(s=>s.classList.remove('activa'));
  document.getElementById(id).classList.add('activa');
}

// LOGIN
function cargarLogin(){
  loginUser.value = '';
  loginPass.value = '';
  loginMsg.innerText = '';
  loginSelect.innerHTML='';
  g('ops').filter(o=>o.activo).forEach(o=>{
    loginSelect.innerHTML+=`<option value="${o.id}">${o.usuario}</option>`;
  });
}
cargarLogin();

function login(){
  const u = loginUser.value.trim();
  const p = loginPass.value.trim();

  const op = g('ops').find(o =>
    o.usuario === u &&
    o.clave === p &&
    o.activo &&
    !o.bloqueado
  );

  if(!op){
    loginMsg.innerText = "‚ùå Usuario o clave incorrectos o bloqueado";
    return;
  }

  operadorActivo = op;
  loginMsg.innerText = `‚úî Bienvenido ${op.nombre}`;
  show('operacion');

  if(op.rol === 'admin'){
    document.querySelector("[onclick=\"show('operadores')\"]").style.display='block';
  } else {
    document.querySelector("[onclick=\"show('operadores')\"]").style.display='none';
  }
}

// OPERACION
function iniciar(){
  if(!operadorActivo) return alert('Debe iniciar sesi√≥n');

  localStorage.setItem(patente.value, JSON.stringify({
    e: Date.now(),
    sector: operadorActivo.sector,
    op: operadorActivo.usuario
  }));
}

function detener(){
  const d = JSON.parse(localStorage.getItem(patente.value));
  if(!d) return alert('No encontrada');
  if(d.sector !== operadorActivo.sector) return alert('Fuera de sector');

  const min = Math.max(1, Math.floor((Date.now() - d.e) / 60000));
  const total = min * 30;
  resultado.innerText = `Total $${total}`;

  const url = `https://parkfacil.cl/validar?patente=${patente.value}&sector=${d.sector}`;
  qr.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}">`;

  localStorage.removeItem(patente.value);
}

// OPERADORES
function cargarSectores(){
  opSector.innerHTML='';
  g('sectores').forEach(s=>{
    opSector.innerHTML+=`<option value="${s.id}">${s.n}</option>`;
  });
}
cargarSectores();

function crearOperador(){
  if(!operadorActivo || operadorActivo.rol !== 'admin'){
    alert('Solo admin puede agregar operadores');
    return;
  }

  const ops = g('ops');

  ops.push({
    id: Date.now(),
    nombre: `${opNombre.value} ${opApellido.value}`,
    usuario: opUsuario.value,
    clave: opClave.value,
    rol: opRol.value,
    sector: +opSector.value,
    activo: true,
    bloqueado: false
  });

  s('ops', ops);
  cargarTabla();
  cargarLogin();
  limpiarCamposOperador();
}

function limpiarCamposOperador(){
  opNombre.value = '';
  opApellido.value = '';
  opCorreo.value = '';
  opTelefono.value = '';
  opUsuario.value = '';
  opClave.value = '';
  opRol.value = 'operador';
  opSector.selectedIndex = 0;
}

function toggleOperador(id){
  const ops = g('ops');
  const o = ops.find(x => x.id === id);
  o.activo = !o.activo;
  s('ops', ops);
  cargarTabla();
  cargarLogin();
}

function cargarTabla(){
  tablaOps.innerHTML = '';
  g('ops').forEach(o => {
    const sec = g('sectores').find(s => s.id === o.sector).n;
    tablaOps.innerHTML += `
      <tr>
        <td>${o.nombre}</td>
        <td>${o.rol}</td>
        <td>${sec}</td>
        <td><span class="badge ${o.activo ? 'ok' : 'block'}">${o.activo ? 'Activo' : 'Bloqueado'}</span></td>
        <td>
          <button class="gris" onclick="toggleOperador(${o.id})">
            ${o.activo ? 'Bloquear' : 'Desbloquear'}
          </button>
        </td>
      </tr>`;
  });
}
cargarTabla();
</script>
</body>
</html>
