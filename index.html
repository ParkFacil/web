<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PARKFACIL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f5f7fa}
.layout{display:flex;min-height:100vh}
.sidebar{width:220px;background:#0f172a;color:#fff}
.brand{padding:16px;font-size:18px;border-bottom:1px solid #334155}
.menu div{padding:14px 16px;cursor:pointer}
.menu div:hover{background:#1e293b}
.menu div.hidden{display:none}
.content{flex:1;padding:24px}
.seccion{display:none;max-width:900px}
.seccion.activa{display:block}
.card{background:#fff;padding:20px;border-radius:10px}
input,select,button{width:100%;padding:10px;margin-top:8px}
button{border:none;border-radius:6px;color:#fff;cursor:pointer}
.azul{background:#2563eb}
.verde{background:#16a34a}
.rojo{background:#dc2626}
.gris{background:#6b7280}
.badge{padding:4px 6px;border-radius:4px;font-size:12px}
.ok{background:#16a34a;color:#fff}
.block{background:#dc2626;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border-bottom:1px solid #ddd;padding:6px}
</style>
</head>

<body>
<div class="layout">

<div class="sidebar">
  <div class="brand">PARKFACIL</div>
  <div class="menu">
    <div onclick="show('login')">ðŸ”‘ Login</div>
    <div id="mOp" class="hidden" onclick="show('operacion')">ðŸš— OperaciÃ³n</div>
    <div id="mAdm" class="hidden" onclick="show('usuarios')">ðŸ‘¤ Usuarios</div>
  </div>
</div>

<div class="content">

<!-- ADMIN INICIAL -->
<div id="bootstrap" class="seccion">
  <div class="card">
    <h3>Administrador inicial</h3>
    <input id="bNombre" placeholder="Nombre">
    <input id="bUsuario" placeholder="Usuario">
    <input id="bClave" type="password" placeholder="Clave">
    <button class="verde" onclick="crearAdmin()">Crear administrador</button>
  </div>
</div>

<!-- LOGIN -->
<div id="login" class="seccion">
  <div class="card">
    <h3>Login</h3>
    <input id="loginUser" placeholder="Usuario">
    <input id="loginPass" type="password" placeholder="Clave">
    <button class="verde" onclick="login()">Ingresar</button>
    <div id="loginMsg"></div>
  </div>
</div>

<!-- OPERACION -->
<div id="operacion" class="seccion">
  <div class="card">
    <h3>OperaciÃ³n</h3>
    <div id="info"></div>
    <input id="patente" placeholder="CX-PY-95">
    <button class="azul" onclick="iniciar()">Iniciar</button>
    <button class="rojo" onclick="detener()">Detener</button>
    <div id="resultado"></div>
  </div>
</div>

<!-- USUARIOS -->
<div id="usuarios" class="seccion">
  <div class="card">
    <h3>GestiÃ³n de usuarios</h3>

    <input id="uNombre" placeholder="Nombre">
    <input id="uUsuario" placeholder="Usuario">
    <input id="uClave" type="password" placeholder="Clave">

    <select id="uRol">
      <option value="operador">Operador</option>
      <option value="admin">Admin</option>
    </select>

    <select id="uSector">
      <option value="1">Sector A</option>
      <option value="2">Sector B</option>
    </select>

    <button class="verde" onclick="crearUsuario()">Crear usuario</button>

    <table>
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Rol</th>
          <th>Sector</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla"></tbody>
    </table>
  </div>
</div>

</div>
</div>

<script>
const g=k=>JSON.parse(localStorage.getItem(k)||'[]');
const s=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
let activo=null;

// INIT
if(g('usuarios').length===0){
  show('bootstrap');
}else{
  show('login');
}

function show(id){
  document.querySelectorAll('.seccion').forEach(x=>x.classList.remove('activa'));
  document.getElementById(id).classList.add('activa');
}

// ADMIN INICIAL
function crearAdmin(){
  s('usuarios',[{
    id:Date.now(),
    nombre:bNombre.value,
    usuario:bUsuario.value,
    clave:bClave.value,
    rol:'admin',
    sector:1,
    activo:true,
    bloqueado:false
  }]);
  show('login');
}

// LOGIN
function login(){
  const u=g('usuarios').find(x=>
    x.usuario===loginUser.value &&
    x.clave===loginPass.value &&
    x.activo &&
    !x.bloqueado
  );
  if(!u){ loginMsg.innerText='Credenciales invÃ¡lidas o bloqueado'; return; }
  activo=u;
  mOp.classList.remove('hidden');
  if(u.rol==='admin') mAdm.classList.remove('hidden');
  info.innerText=`${u.nombre} | ${u.rol} | Sector ${u.sector}`;
  show('operacion');
}

// USUARIOS
function crearUsuario(){
  if(activo.rol!=='admin') return;

  const arr=g('usuarios');
  arr.push({
    id:Date.now(),
    nombre:uNombre.value,
    usuario:uUsuario.value,
    clave:uClave.value,
    rol:uRol.value,
    sector:+uSector.value,
    activo:true,
    bloqueado:false
  });
  s('usuarios',arr);
  cargarTabla();
}

function cargarTabla(){
  tabla.innerHTML='';
  g('usuarios').filter(u=>u.activo).forEach(u=>{
    tabla.innerHTML+=`
      <tr>
        <td>${u.usuario}</td>
        <td>${u.rol}</td>
        <td>${u.sector}</td>
        <td>
          <span class="badge ${u.bloqueado?'block':'ok'}">
            ${u.bloqueado?'Bloqueado':'Activo'}
          </span>
        </td>
        <td>
          <button class="gris" onclick="bloquear(${u.id})">
            ${u.bloqueado?'Desbloquear':'Bloquear'}
          </button>
          <button class="rojo" onclick="eliminar(${u.id})">
            Eliminar
          </button>
        </td>
      </tr>`;
  });
}

function bloquear(id){
  const arr=g('usuarios');
  const u=arr.find(x=>x.id===id);
  u.bloqueado=!u.bloqueado;
  s('usuarios',arr);
  cargarTabla();
}

function eliminar(id){
  if(!confirm('Eliminar usuario?')) return;
  const arr=g('usuarios');
  const u=arr.find(x=>x.id===id);
  u.activo=false;
  s('usuarios',arr);
  cargarTabla();
}

// OPERACION
function iniciar(){
  localStorage.setItem(patente.value,JSON.stringify({
    entrada:Date.now(),
    sector:activo.sector,
    operador:activo.usuario
  }));
}

function detener(){
  const d=JSON.parse(localStorage.getItem(patente.value));
  if(!d||d.sector!==activo.sector) return alert('No autorizado');
  const min=Math.max(1,Math.floor((Date.now()-d.entrada)/60000));
  resultado.innerText=`Total $${min*30}`;
  localStorage.removeItem(patente.value);
}

cargarTabla();
</script>
</body>
</html>
