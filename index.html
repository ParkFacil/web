<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PARKFACIL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:monospace;background:#f3f4f6;display:flex;justify-content:center;padding:10px}
.card{background:#fff;width:100%;max-width:380px;padding:14px;border-radius:10px}
input,button{width:100%;padding:12px;margin-top:8px;font-size:16px}
button{border:none;border-radius:8px;color:#fff;cursor:pointer}
.blue{background:#2563eb}
.red{background:#dc2626}
.gray{background:#6b7280}
.green{background:#22c55e}
.ticket{width:58mm;margin:12px auto;font-size:12px}
.centro{text-align:center}
hr{border:none;border-top:1px dashed #000;margin:6px 0}
</style>
</head>

<body>
<div class="card">

<!-- LOGIN OPERADOR -->
<div id="loginBox">
  <div class="centro"><b>PARKFACIL</b></div>
  <input id="operadorInput" placeholder="Código Operador">
  <button class="blue" onclick="login()">Iniciar Turno</button>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="centro"><b>Operador:</b> <span id="opNombre"></span></div>

  <input id="patente" placeholder="CX-PY-95" maxlength="8">

  <button class="blue" onclick="iniciar()">Iniciar estadía</button>
  <button class="red" onclick="detener()">Detener estadía</button>
  <button class="gray" onclick="buscar()">Buscar patente</button>

  <button class="green" onclick="cierre()">Cierre de Turno</button>

  <div id="resultado"></div>
</div>

</div>

<script>
const VALOR_MIN = 30;
const IVA = 0.19;

let operador = null;

/* ========= LOGIN ========= */
function login(){
  const op = operadorInput.value.trim();
  if(!op) return alert('Ingrese operador');
  operador = op;
  localStorage.setItem('operadorActivo', op);
  document.getElementById('opNombre').textContent = op;
  document.getElementById('loginBox').style.display='none';
  document.getElementById('app').style.display='block';
}

(function autoLogin(){
  const op = localStorage.getItem('operadorActivo');
  if(op){
    operador = op;
    document.getElementById('opNombre').textContent = op;
    document.getElementById('loginBox').style.display='none';
    document.getElementById('app').style.display='block';
  }
})();

/* ========= PATENTE ========= */
patente.addEventListener('input',()=>{
  let r = patente.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
  let o = r.substring(0,2);
  if(r.length>2) o+='-'+r.substring(2,4);
  if(r.length>4) o+='-'+r.substring(4,6);
  patente.value=o;
});

/* ========= FUNCIONES ========= */

function iniciar(){
  if(!operador) return alert('Operador no activo');
  const p = patente.value;
  if(!/^[A-Z]{2}-[A-Z]{2}-\d{2}$/.test(p)) return alert('Patente inválida');

  localStorage.setItem(p, JSON.stringify({
    entrada: new Date(),
    operador
  }));

  ticket('ENTRADA',[
    `Patente: ${p}`,
    `Operador: ${operador}`,
    `Hora: ${new Date().toLocaleTimeString()}`
  ]);
}

function detener(){
  const p = patente.value;
  const d = JSON.parse(localStorage.getItem(p) || null);
  if(!d) return alert('Patente no encontrada');

  const salida = new Date();
  const min = Math.max(1, Math.floor((salida - new Date(d.entrada))/60000));
  const sub = min * VALOR_MIN;
  const iva = Math.round(sub*IVA);
  const total = sub+iva;

  const id = 'T-'+Date.now();

  localStorage.setItem(id, JSON.stringify({
    operador:d.operador,
    total,
    fecha:salida
  }));

  localStorage.removeItem(p);

  ticket('SALIDA',[
    `Patente: ${p}`,
    `Minutos: ${min}`,
    `TOTAL: $${total}`
  ]);
}

function buscar(){
  const p = patente.value;
  const d = JSON.parse(localStorage.getItem(p)||null);
  if(!d) return alert('No encontrada');

  ticket('ESTADÍA ACTIVA',[
    `Patente: ${p}`,
    `Operador: ${d.operador}`,
    `Entrada: ${new Date(d.entrada).toLocaleTimeString()}`
  ]);
}

/* ========= CIERRE ========= */

function cierre(){
  let total = 0;
  let cant = 0;

  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith('T-')){
      const t = JSON.parse(localStorage.getItem(k));
      if(t.operador===operador){
        total+=t.total;
        cant++;
        localStorage.removeItem(k);
      }
    }
  });

  localStorage.removeItem('operadorActivo');
  operador=null;

  ticket('CIERRE DE TURNO',[
    `Operador: ${operadorInput.value}`,
    `Tickets: ${cant}`,
    `TOTAL: $${total}`,
    `Fecha: ${new Date().toLocaleString()}`
  ]);

  setTimeout(()=>location.reload(),3000);
}

/* ========= TICKET ========= */

function ticket(titulo,lineas){
  let h=`<div class="ticket"><div class="centro"><b>${titulo}</b></div><hr>`;
  lineas.forEach(l=>{
    if(l.startsWith('TOTAL')) h+=`<div class="centro"><b>${l}</b></div>`;
    else h+=`<div>${l}</div>`;
  });
  h+=`<hr><div class="centro">PARKFACIL</div></div>`;
  resultado.innerHTML=h;
}
</script>
</body>
</html>
