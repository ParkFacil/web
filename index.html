<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Estacionamiento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: monospace;
  background:#f5f7fa;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  background:#fff;
  padding:6px;
  border-radius:6px;
  width:58mm;
  box-shadow:0 0 5px rgba(0,0,0,.15);
}
h1{text-align:center;font-size:14px;margin:4px 0;}
label{font-size:12px;font-weight:bold;}
input,button{
  width:100%;
  padding:6px;
  margin-top:4px;
  font-size:12px;
}
button{
  border:none;
  border-radius:4px;
  color:#fff;
  cursor:pointer;
}
#btnIniciar{background:#2563eb;}
#btnDetener{background:#dc2626;}
#btnBuscar{background:#6b7280;}
#btnReporte{background:#059669;}
#btnReporteWeb{background:#7c3aed;}

.resultado{
  margin-top:6px;
  background:#fff;
  padding:4px;
  font-size:12px;
}

.tabla-reporte{
  width:100%;
  border-collapse:collapse;
  font-size:11px;
  margin-top:6px;
}
.tabla-reporte th,
.tabla-reporte td{
  border:1px solid #000;
  padding:4px;
}
.tabla-reporte th{
  background:#e5e7eb;
}

hr{
  border:none;
  border-top:1px dashed #000;
  margin:4px 0;
}

@media print{
  body{background:#fff;}
  input,button,label,h1{display:none;}
  .card{box-shadow:none;}
}
</style>
</head>

<body>
<div class="card">

<h1>PARKFACIL</h1>

<label>Patente</label>
<input id="patente" placeholder="CX-PY-95" maxlength="8">

<button id="btnIniciar">Iniciar estadía</button>
<button id="btnDetener">Detener estadía</button>
<button id="btnBuscar">Buscar patente</button>
<button id="btnReporte">Reporte (Ticket)</button>

<label>Fecha del reporte</label>
<input type="date" id="fechaReporte">
<button id="btnReporteWeb">Reporte Web por día</button>

<div id="resultado" class="resultado" style="display:none"></div>

</div>

<script>
// ===== CONFIG =====
var VALOR_POR_MINUTO = 30;
var IVA = 0.19;
var inputPatente = document.getElementById('patente');

// ===== BOTONES =====
btnIniciar.onclick = iniciarEstadia;
btnDetener.onclick = detenerEstadia;
btnBuscar.onclick = buscarPatente;
btnReporte.onclick = mostrarReporteTicket;
btnReporteWeb.onclick = mostrarReporteWebPorDia;

// ===== REGISTRO DE EVENTOS =====
function registrarEvento(tipo, patente){
  var log = JSON.parse(localStorage.getItem('reporte_estadias') || '[]');
  log.push({
    tipo: tipo,
    patente: patente,
    fecha: new Date().toISOString()
  });
  localStorage.setItem('reporte_estadias', JSON.stringify(log));
}

// ===== TICKET 58MM =====
function imprimirTicket(titulo, lineas){
  var res = document.getElementById('resultado');
  res.style.display='block';
  let html = `
    <center><b>${titulo}</b></center>
    <center>PARKFACIL</center>
    <hr>
  `;
  lineas.forEach(l=>html+=`<div>${l}</div>`);
  html+=`<hr><center>Gracias por su visita</center>`;
  res.innerHTML = html;
}

// ===== INICIAR =====
function iniciarEstadia(){
  var p = inputPatente.value;
  if(!p) return alert('Ingrese patente');

  var entrada = new Date();
  localStorage.setItem(p, JSON.stringify({entrada: entrada}));
  registrarEvento('INICIO', p);

  imprimirTicket('TICKET DE ENTRADA',[
    'Patente: '+p,
    'Fecha: '+entrada.toLocaleDateString(),
    'Hora: '+entrada.toLocaleTimeString()
  ]);
}

// ===== DETENER =====
function detenerEstadia(){
  var p = inputPatente.value;
  var d = localStorage.getItem(p);
  if(!d) return alert('Patente no encontrada');

  var entrada = new Date(JSON.parse(d).entrada);
  var salida = new Date();
  var min = Math.max(1,Math.floor((salida-entrada)/60000));
  var sub = min * VALOR_POR_MINUTO;
  var iva = Math.round(sub * IVA);
  var total = sub + iva;

  registrarEvento('DETENCION', p);
  localStorage.removeItem(p);

  imprimirTicket('TICKET DE SALIDA',[
    'Patente: '+p,
    'Minutos: '+min,
    'Subtotal: $'+sub,
    'IVA: $'+iva,
    'TOTAL: $'+total
  ]);
}

// ===== BUSCAR =====
function buscarPatente(){
  var p = inputPatente.value;
  if(localStorage.getItem(p)){
    registrarEvento('CONSULTA', p);
    imprimirTicket('PATENTE EN SISTEMA',['Patente: '+p]);
  }else{
    alert('Patente no encontrada');
  }
}

// ===== REPORTE TICKET =====
function mostrarReporteTicket(){
  var rep = JSON.parse(localStorage.getItem('reporte_estadias') || '[]');
  if(rep.length===0) return alert('Sin registros');

  imprimirTicket('REPORTE GENERAL',
    rep.slice(-10).map(r =>
      new Date(r.fecha).toLocaleString()+' '+r.tipo+' '+r.patente
    )
  );
}

// ===== REPORTE WEB POR DÍA =====
function mostrarReporteWebPorDia(){
  var fechaSel = document.getElementById('fechaReporte').value;
  var res = document.getElementById('resultado');
  res.style.display='block';

  if(!fechaSel){
    res.innerHTML = '<b>Seleccione una fecha</b>';
    return;
  }

  var rep = JSON.parse(localStorage.getItem('reporte_estadias') || '[]');

  var filtrados = rep.filter(r=>{
    var d = new Date(r.fecha).toISOString().split('T')[0];
    return d === fechaSel;
  });

  if(filtrados.length===0){
    res.innerHTML = `<b>Sin registros para ${fechaSel}</b>`;
    return;
  }

  let html = `
    <b>REPORTE DEL DÍA ${fechaSel}</b>
    <table class="tabla-reporte">
      <tr>
        <th>Hora</th>
        <th>Evento</th>
        <th>Patente</th>
      </tr>
  `;

  filtrados.forEach(r=>{
    html+=`
      <tr>
        <td>${new Date(r.fecha).toLocaleTimeString()}</td>
        <td>${r.tipo}</td>
        <td>${r.patente}</td>
      </tr>
    `;
  });

  html+=`
    </table>
    <div><b>Total eventos:</b> ${filtrados.length}</div>
  `;

  res.innerHTML = html;
}
</script>
</body>
</html>
