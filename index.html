<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Estacionamiento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Arial;
  background:#f5f7fa;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh
}
.card{
  background:#fff;
  padding:24px;
  border-radius:12px;
  width:100%;
  max-width:420px;
  box-shadow:0 10px 25px rgba(0,0,0,.1)
}
h1{text-align:center}
label{font-weight:bold}
input,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  font-size:16px
}
button{
  border:none;
  border-radius:8px;
  color:#fff;
  cursor:pointer
}
#btnIniciar{background:#2563eb}
#btnDetener{background:#dc2626}
#btnBuscar{background:#6b7280}
#btnWhatsapp{background:#25D366}
#btnMail{background:#0f172a}

.resultado{
  margin-top:16px;
  background:#f1f5f9;
  padding:12px;
  border-radius:8px;
  display:none
}

.sugerencias{
  border:1px solid #ddd;
  border-radius:6px;
  margin-top:6px;
  display:none;
  max-height:150px;
  overflow-y:auto
}
.sugerencias div{
  padding:8px;
  cursor:pointer;
  border-bottom:1px solid #e5e7eb
}
.sugerencias div:hover{
  background:#e5e7eb
}
</style>
</head>

<body>
<div class="card">
<h1>Control de Estacionamiento</h1>

<label>Patente</label>
<input id="patente" placeholder="CX-PY-95" maxlength="8">

<div id="listaPatentes" class="sugerencias"></div>

<button id="btnIniciar">Iniciar estadía</button>
<button id="btnDetener">Detener estadía</button>
<button id="btnBuscar">Buscar patente</button>

<div id="resultado" class="resultado"></div>

<button id="btnWhatsapp" style="display:none">Enviar por WhatsApp</button>
<button id="btnMail" style="display:none">Enviar por Email</button>
</div>

<script>
const VALOR_POR_MINUTO = 30;
const IVA = 0.19;

const inputPatente = document.getElementById('patente');
const resultado = document.getElementById('resultado');
const lista = document.getElementById('listaPatentes');
const btnWhatsapp = document.getElementById('btnWhatsapp');
const btnMail = document.getElementById('btnMail');

let ultimoTicketTexto = '';

// FORMATEO PATENTE
inputPatente.addEventListener('input', function(){
  let raw = this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
  let out = raw.substring(0,2);
  if(raw.length>2) out += '-' + raw.substring(2,4);
  if(raw.length>4) out += '-' + raw.substring(4,6);
  this.value = out;
});

// BOTONES
btnBuscar.onclick = buscarPatentes;
document.getElementById('btnIniciar').onclick = iniciarEstadia;
document.getElementById('btnDetener').onclick = detenerEstadia;
btnWhatsapp.onclick = enviarWhatsapp;
btnMail.onclick = enviarMail;

// FUNCIONES
function iniciarEstadia(){
  const p = inputPatente.value;
  if(!/^[A-Z]{2}-[A-Z]{2}-\d{2}$/.test(p)){
    alert('Patente inválida');
    return;
  }
  localStorage.setItem(p, JSON.stringify({ entrada: new Date().toISOString() }));
  alert('Estadía iniciada: ' + p);
}

function buscarPatentes(){
  lista.innerHTML = '';
  lista.style.display = 'block';

  const patentes = Object.keys(localStorage)
    .filter(k => /^[A-Z]{2}-[A-Z]{2}-\d{2}$/.test(k));

  if(patentes.length === 0){
    lista.innerHTML = '<div>No hay patentes registradas</div>';
    return;
  }

  patentes.forEach(p=>{
    const div = document.createElement('div');
    div.textContent = p;
    div.onclick = ()=>{
      inputPatente.value = p;
      lista.style.display = 'none';
      mostrarTiempo(p);
    };
    lista.appendChild(div);
  });
}

function mostrarTiempo(p){
  const data = JSON.parse(localStorage.getItem(p));
  const entrada = new Date(data.entrada);
  const minutos = Math.floor((new Date() - entrada) / 60000);

  resultado.style.display = 'block';
  resultado.innerHTML = `
    <b>CONSULTA DE ESTADÍA</b><br><br>
    Patente: ${p}<br>
    Entrada: ${entrada.toLocaleString()}<br>
    Minutos: ${minutos}
  `;
}

function detenerEstadia(){
  const p = inputPatente.value;
  const data = localStorage.getItem(p);
  if(!data){ alert('Patente no encontrada'); return; }

  const entrada = new Date(JSON.parse(data).entrada);
  const salida = new Date();
  const minutos = Math.max(1, Math.floor((salida - entrada) / 60000));
  const subtotal = minutos * VALOR_POR_MINUTO;
  const total = Math.round(subtotal * (1 + IVA));

  localStorage.removeItem(p);

  ultimoTicketTexto =
`TICKET ESTACIONAMIENTO
Patente: ${p}
Entrada: ${entrada.toLocaleString()}
Salida: ${salida.toLocaleString()}
Minutos: ${minutos}
Total: $${total}`;

  resultado.style.display = 'block';
  resultado.innerHTML = ultimoTicketTexto.replace(/\n/g,'<br>');

  btnWhatsapp.style.display = 'block';
  btnMail.style.display = 'block';
}

function enviarWhatsapp(){
  const url = `https://wa.me/?text=${encodeURIComponent(ultimoTicketTexto)}`;
  window.open(url,'_blank');
}

function enviarMail(){
  const mailto =
`mailto:?subject=Ticket Estacionamiento&body=${encodeURIComponent(ultimoTicketTexto)}`;
  window.location.href = mailto;
}
</script>
</body>
</html>
