<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Estacionamiento – Piloto</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f1f5f9;display:flex}
aside{width:220px;background:#111827;color:#fff;padding:16px}
aside h3{margin-top:0}
aside button{width:100%;margin:6px 0;padding:8px;border:0;border-radius:6px;cursor:pointer}
main{flex:1;padding:20px}
.hidden{display:none}
.card{background:#fff;padding:16px;border-radius:10px;margin-bottom:16px}
input,select,button{width:100%;padding:8px;margin:4px 0}
table{width:100%;border-collapse:collapse}
td,th{border-bottom:1px solid #ddd;padding:6px;text-align:left}
.ticket{font-family:monospace;width:220px;margin:auto}
.center{text-align:center}
hr{border:none;border-top:1px dashed #000}
</style>
</head>
<body>

<aside>
  <h3>Panel</h3>
  <button onclick="show('login')">Login</button>
  <button onclick="show('operacion')">Operación</button>
  <button onclick="show('operadores')">Operadores</button>
  <button onclick="show('sectores')">Sectores</button>
  <button onclick="logout()">Logout</button>
</aside>

<main>

<!-- LOGIN -->
<div id="login" class="card">
  <h3>Login</h3>
  <input id="lUser" placeholder="Usuario">
  <input id="lPass" type="password" placeholder="Clave">
  <button onclick="login()">Ingresar</button>
  <div id="lMsg"></div>
</div>

<!-- OPERACION -->
<div id="operacion" class="card hidden">
  <h3>Operación</h3>
  <input id="patente" placeholder="AA-BB-11">
  <button onclick="iniciar()">Iniciar Estadía</button>
  <button onclick="listarActivas()">Buscar Patentes Activas</button>
  <div id="lista"></div>
  <div id="ticket"></div>
</div>

<!-- OPERADORES -->
<div id="operadores" class="card hidden">
  <h3>Operadores</h3>
  <input id="opNombre" placeholder="Nombre completo">
  <input id="opUser" placeholder="Usuario">
  <input id="opPass" placeholder="Clave">
  <select id="opRol">
    <option value="operador">Operador</option>
    <option value="admin">Admin</option>
  </select>
  <select id="opSector"></select>
  <button onclick="crearOperador()">Crear</button>
  <table id="tablaOps"></table>
</div>

<!-- SECTORES -->
<div id="sectores" class="card hidden">
  <h3>Sectores</h3>
  <input id="secNombre" placeholder="Nombre sector">
  <button onclick="crearSector()">Crear sector</button>
  <ul id="listaSectores"></ul>
</div>

</main>

<script>
// ====== ESTADO ======
let usuario = null;

// ====== STORAGE ======
const g = k => JSON.parse(localStorage.getItem(k)||'[]');
const s = (k,v) => localStorage.setItem(k,JSON.stringify(v));

// ====== INIT ======
(function(){
  if(!localStorage.getItem('ops')){
    s('ops',[{id:1,nombre:'Administrador',usuario:'admin',clave:'admin',rol:'admin',sector:null,activo:true}]);
  }
  if(!localStorage.getItem('sectores')){
    s('sectores',[]);
  }
})();

// ====== UI ======
function show(id){
  document.querySelectorAll('main > div').forEach(d=>d.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(id==='operadores') cargarOps();
  if(id==='sectores') cargarSectores();
  if(id==='operacion') cargarSectoresSelect();
}

// ====== LOGIN ======
function login(){
  const u=lUser.value,p=lPass.value;
  const op=g('ops').find(o=>o.usuario===u&&o.clave===p&&o.activo);
  if(!op){lMsg.innerText='Credenciales inválidas';return;}
  usuario=op;
  show('operacion');
}

// ====== LOGOUT ======
function logout(){
  usuario=null;
  show('login');
}

// ====== SECTORES ======
function crearSector(){
  const secs=g('sectores');
  secs.push({id:Date.now(),nombre:secNombre.value});
  s('sectores',secs);
  cargarSectores();
}
function cargarSectores(){
  listaSectores.innerHTML='';
  g('sectores').forEach(sx=>{
    const li=document.createElement('li');
    li.innerHTML=sx.nombre+' <button onclick="eliminarSector('+sx.id+')">X</button>';
    listaSectores.appendChild(li);
  });
}
function eliminarSector(id){
  s('sectores',g('sectores').filter(sx=>sx.id!==id));
  cargarSectores();
}

// ====== OPERADORES ======
function cargarSectoresSelect(){
  opSector.innerHTML='';
  g('sectores').forEach(sx=>{
    const o=document.createElement('option');
    o.value=sx.id;o.textContent=sx.nombre;
    opSector.appendChild(o);
  });
}
function crearOperador(){
  if(usuario.rol!=='admin')return;
  const ops=g('ops');
  ops.push({
    id:Date.now(),
    nombre:opNombre.value,
    usuario:opUser.value,
    clave:opPass.value,
    rol:opRol.value,
    sector:+opSector.value,
    activo:true
  });
  s('ops',ops);
  cargarOps();
}
function cargarOps(){
  const t=tablaOps;
  t.innerHTML='<tr><th>Usuario</th><th>Rol</th><th>Sector</th><th>Estado</th><th></th></tr>';
  g('ops').forEach(o=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${o.usuario}</td>
    <td>${o.rol}</td>
    <td>${o.sector||''}</td>
    <td>${o.activo?'Activo':'Bloq'}</td>
    <td>
      <button onclick="toggleOp(${o.id})">Bloq</button>
      <button onclick="delOp(${o.id})">Del</button>
    </td>`;
    t.appendChild(tr);
  });
}
function toggleOp(id){
  const ops=g('ops');
  ops.find(o=>o.id===id).activo^=true;
  s('ops',ops);cargarOps();
}
function delOp(id){
  s('ops',g('ops').filter(o=>o.id!==id));
  cargarOps();
}

// ====== OPERACION ======
function iniciar(){
  if(usuario.rol==='operador' && !usuario.sector){alert('Sin sector');return;}
  localStorage.setItem(patente.value,JSON.stringify({
    entrada:Date.now(),
    operador:usuario.usuario,
    sector:usuario.sector
  }));
}
function listarActivas(){
  lista.innerHTML='';
  Object.keys(localStorage).forEach(k=>{
    if(/^[A-Z]{2}-[A-Z]{2}-\d{2}$/.test(k)){
      const d=JSON.parse(localStorage.getItem(k));
      if(usuario.rol==='operador' && d.sector!==usuario.sector)return;
      const b=document.createElement('button');
      b.textContent=k;
      b.onclick=()=>cerrar(k);
      lista.appendChild(b);
    }
  });
}
function cerrar(p){
  const d=JSON.parse(localStorage.getItem(p));
  const min=Math.max(1,Math.floor((Date.now()-d.entrada)/60000));
  const total=min*30;
  localStorage.removeItem(p);
  ticket.innerHTML=`
  <div class="ticket">
  <div class="center"><b>PARKFACIL</b></div>
  <hr>
  Patente: ${p}<br>
  Minutos: ${min}<br>
  Total: $${total}
  <hr>
  <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://validar/${p}">
  <br>
  <button onclick="wa('${p}',${total})">WhatsApp</button>
  <button onclick="mail('${p}',${total})">Correo</button>
  </div>`;
}
function wa(p,t){
  window.open(`https://wa.me/?text=Ticket ${p} Total $${t}`);
}
function mail(p,t){
  window.location=`mailto:?subject=Ticket ${p}&body=Total $${t}`;
}
</script>
</body>
</html>
