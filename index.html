<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PARKFACIL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#f1f5f9}
.sidebar{width:220px;background:#0f172a;color:#fff;position:fixed;height:100vh}
.sidebar h2{margin:0;padding:16px;font-size:18px;border-bottom:1px solid #334155}
.sidebar div{padding:14px 16px;cursor:pointer}
.sidebar div:hover{background:#1e293b}
.content{margin-left:220px;padding:20px}
.hidden{display:none}
.card{background:#fff;padding:20px;border-radius:10px;max-width:500px}
input,select,button{width:100%;padding:10px;margin-top:8px}
button{border:none;border-radius:6px;color:#fff;cursor:pointer}
.azul{background:#2563eb}
.verde{background:#16a34a}
.rojo{background:#dc2626}
.gris{background:#6b7280}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #ddd;padding:6px}
.ticket{width:220px;margin-top:15px;border:1px dashed #000;padding:8px;font-size:12px}
.ticket h3{text-align:center;margin:4px 0}
.c{text-align:center}
</style>
</head>

<body>

<div class="sidebar">
  <h2>PARKFACIL</h2>
  <div onclick="mostrar('login')">üîë Login</div>
  <div onclick="mostrar('operacion')" id="mOp" class="hidden">üöó Operar</div>
  <div onclick="mostrar('usuarios')" id="mUsr" class="hidden">üë§ Operadores</div>
  <div onclick="logout()" id="mOut" class="hidden">‚èª Logout</div>
</div>

<div class="content">

<!-- LOGIN -->
<div id="login" class="card">
  <h3>Login</h3>
  <input id="lUser" placeholder="Usuario">
  <input id="lPass" type="password" placeholder="Clave">
  <button class="verde" onclick="login()">Ingresar</button>
  <div id="msg"></div>
</div>

<!-- OPERACION -->
<div id="operacion" class="card hidden">
  <h3>Operaci√≥n</h3>
  <div id="info"></div>

  <input id="patente" placeholder="CX-PY-95">
  <button class="azul" onclick="iniciar()">Iniciar</button>

  <h4>Patentes activas</h4>
  <select id="lista"></select>
  <button class="rojo" onclick="detener()">Detener</button>

  <div id="ticket"></div>
</div>

<!-- USUARIOS -->
<div id="usuarios" class="card hidden">
  <h3>Operadores</h3>

  <input id="uUser" placeholder="Usuario">
  <input id="uPass" placeholder="Clave">
  <select id="uSector">
    <option value="A">Sector A</option>
    <option value="B">Sector B</option>
  </select>
  <button class="verde" onclick="crearOperador()">Crear operador</button>

  <table>
    <thead><tr><th>Usuario</th><th>Sector</th><th>Estado</th><th></th></tr></thead>
    <tbody id="tabla"></tbody>
  </table>
</div>

</div>

<script>
/* === INIT === */
if(!localStorage.getItem('usuarios')){
  localStorage.setItem('usuarios',JSON.stringify([{
    usuario:'admin',clave:'admin',rol:'admin',sector:'ALL',activo:true
  }]));
}

let usuarioActivo=null;
const getU=()=>JSON.parse(localStorage.getItem('usuarios'));
const setU=v=>localStorage.setItem('usuarios',JSON.stringify(v));

function mostrar(id){
  ['login','operacion','usuarios'].forEach(x=>document.getElementById(x).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

/* LOGIN */
function login(){
  const u=getU().find(x=>x.usuario===lUser.value && x.clave===lPass.value && x.activo);
  if(!u){msg.innerText='Credenciales inv√°lidas';return;}
  usuarioActivo=u;
  mOp.classList.remove('hidden');
  mOut.classList.remove('hidden');
  if(u.rol==='admin') mUsr.classList.remove('hidden');
  info.innerText=`Usuario: ${u.usuario} | Sector: ${u.sector}`;
  cargarPatentes();
  mostrar('operacion');
}

/* LOGOUT */
function logout(){
  usuarioActivo=null;
  location.reload();
}

/* OPERADORES */
function crearOperador(){
  const arr=getU();
  arr.push({usuario:uUser.value,clave:uPass.value,rol:'operador',sector:uSector.value,activo:true});
  setU(arr);
  cargarTabla();
}
function cargarTabla(){
  tabla.innerHTML='';
  getU().filter(x=>x.rol==='operador').forEach(o=>{
    tabla.innerHTML+=`<tr>
      <td>${o.usuario}</td><td>${o.sector}</td><td>${o.activo?'OK':'OFF'}</td>
      <td><button onclick="bloq('${o.usuario}')">Bloq</button></td>
    </tr>`;
  });
}
function bloq(u){
  const arr=getU(); const o=arr.find(x=>x.usuario===u);
  o.activo=!o.activo; setU(arr); cargarTabla();
}
cargarTabla();

/* OPERACION */
function iniciar(){
  localStorage.setItem('est_'+patente.value,JSON.stringify({
    patente:patente.value,
    sector:usuarioActivo.sector,
    entrada:Date.now()
  }));
  cargarPatentes();
}

function cargarPatentes(){
  lista.innerHTML='';
  Object.keys(localStorage).filter(k=>k.startsWith('est_')).forEach(k=>{
    const d=JSON.parse(localStorage.getItem(k));
    if(usuarioActivo.sector==='ALL'||d.sector===usuarioActivo.sector)
      lista.innerHTML+=`<option value="${k}">${d.patente}</option>`;
  });
}

function detener(){
  const k=lista.value; if(!k)return;
  const d=JSON.parse(localStorage.getItem(k));
  const min=Math.max(1,Math.floor((Date.now()-d.entrada)/60000));
  const total=min*30;
  ticket.innerHTML=`
  <div class="ticket">
    <h3>PARKFACIL</h3>
    <div class="c">Patente ${d.patente}</div>
    <div class="c">Sector ${d.sector}</div>
    <div class="c">Min ${min}</div>
    <div class="c"><b>$${total}</b></div>
    <div class="c">QR:${btoa(d.patente+Date.now()).slice(0,10)}</div>
    <div class="c">Boleta electr√≥nica</div>
  </div>`;
  localStorage.removeItem(k);
  cargarPatentes();
}
</script>
</body>
</html>
