<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PARKFACIL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f5f7fa}
.layout{display:flex;min-height:100vh}
.sidebar{width:230px;background:#0f172a;color:#fff}
.brand{padding:16px;font-size:18px;border-bottom:1px solid #334155}
.menu div{padding:14px 16px;cursor:pointer}
.menu div:hover{background:#1e293b}
.menu div.hidden{display:none}
.content{flex:1;padding:24px}
.seccion{display:none;max-width:900px}
.seccion.activa{display:block}
.card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.1)}
input,select,button{width:100%;padding:10px;margin-top:8px}
button{border:none;border-radius:6px;color:#fff;cursor:pointer}
.azul{background:#2563eb}
.rojo{background:#dc2626}
.verde{background:#16a34a}
.gris{background:#6b7280}
.badge{padding:4px 8px;border-radius:6px;font-size:12px}
.ok{background:#16a34a;color:#fff}
.block{background:#dc2626;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left}
</style>
</head>

<body>
<div class="layout">

<div class="sidebar">
  <div class="brand">PARKFACIL</div>
  <div class="menu">
    <div onclick="show('login')">üîë Login</div>
    <div id="menuOperacion" class="hidden" onclick="show('operacion')">üöó Operaci√≥n</div>
    <div id="menuOps" class="hidden" onclick="show('operadores')">üë§ Operadores</div>
  </div>
</div>

<div class="content">

<!-- LOGIN -->
<div id="login" class="seccion activa">
  <div class="card">
    <h3>Ingreso al sistema</h3>
    <input id="loginUser" placeholder="Usuario">
    <input id="loginPass" type="password" placeholder="Clave">
    <button class="verde" onclick="login()">Ingresar</button>
    <div id="loginMsg"></div>
  </div>
</div>

<!-- OPERACION -->
<div id="operacion" class="seccion">
  <div class="card">
    <h3>Operaci√≥n</h3>
    <div id="opInfo"></div>
    <input id="patente" placeholder="CX-PY-95">
    <button class="azul" onclick="iniciar()">Iniciar estad√≠a</button>
    <button class="rojo" onclick="detener()">Detener estad√≠a</button>
    <div id="resultado"></div>
    <div id="qr"></div>
  </div>
</div>

<!-- OPERADORES -->
<div id="operadores" class="seccion">
  <div class="card">
    <h3>Gesti√≥n de Operadores</h3>
    <input id="opNombre" placeholder="Nombre completo">
    <input id="opUsuario" placeholder="Usuario">
    <input id="opClave" type="password" placeholder="Clave">
    <select id="opRol">
      <option value="operador">Operador</option>
      <option value="admin">Admin</option>
    </select>
    <select id="opSector"></select>
    <button class="verde" onclick="crearOperador()">Crear operador</button>

    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Usuario</th>
          <th>Rol</th>
          <th>Sector</th>
          <th>Estado</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tablaOps"></tbody>
    </table>
  </div>
</div>

</div>
</div>

<script>
// HELPERS
const g=k=>JSON.parse(localStorage.getItem(k)||'[]');
const s=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

// DATOS BASE
if(!g('sectores').length){
  s('sectores',[{id:1,n:'Sector A'},{id:2,n:'Sector B'}]);
}
if(!g('ops').length){
  s('ops',[{
    id:1,nombre:'Admin',usuario:'admin',clave:'admin',
    rol:'admin',sector:1,activo:true
  }]);
}

let operador=null;

// UI
function show(id){
  document.querySelectorAll('.seccion').forEach(x=>x.classList.remove('activa'));
  document.getElementById(id).classList.add('activa');
}

// LOGIN
function login(){
  const u=loginUser.value.trim();
  const p=loginPass.value.trim();
  const op=g('ops').find(o=>o.usuario===u && o.clave===p && o.activo);

  if(!op){
    loginMsg.innerText='‚ùå Credenciales inv√°lidas o bloqueado';
    return;
  }

  operador=op;
  loginMsg.innerText=`‚úî Bienvenido ${op.nombre}`;
  menuOperacion.classList.remove('hidden');
  show('operacion');

  if(op.rol==='admin'){
    menuOps.classList.remove('hidden');
  } else {
    menuOps.classList.add('hidden');
  }

  opInfo.innerHTML=`<span class="badge ok">${op.rol}</span> Sector ${op.sector}`;
}

// OPERACION
function iniciar(){
  if(!operador) return alert('Debe iniciar sesi√≥n');

  localStorage.setItem(patente.value,JSON.stringify({
    entrada:Date.now(),
    sector:operador.sector,
    operador:operador.usuario
  }));
}

function detener(){
  const d=JSON.parse(localStorage.getItem(patente.value));
  if(!d) return alert('No encontrada');
  if(d.sector!==operador.sector) return alert('Fuera de sector');

  const min=Math.max(1,Math.floor((Date.now()-d.entrada)/60000));
  const total=min*30;
  resultado.innerHTML=`Total: $${total}<br>Operador: ${d.operador}`;

  const url=`https://parkfacil.cl/validar?patente=${patente.value}&sector=${d.sector}&op=${d.operador}`;
  qr.innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}">`;

  localStorage.removeItem(patente.value);
}

// OPERADORES
function cargarSectores(){
  opSector.innerHTML='';
  g('sectores').forEach(s=>{
    opSector.innerHTML+=`<option value="${s.id}">${s.n}</option>`;
  });
}
cargarSectores();

function crearOperador(){
  if(operador.rol!=='admin') return alert('Solo admin');

  const ops=g('ops');
  if(ops.some(o=>o.usuario===opUsuario.value)){
    alert('Usuario ya existe');return;
  }

  ops.push({
    id:Date.now(),
    nombre:opNombre.value,
    usuario:opUsuario.value,
    clave:opClave.value,
    rol:opRol.value,
    sector:+opSector.value,
    activo:true
  });

  s('ops',ops);
  cargarTabla();
}

function toggle(id){
  const ops=g('ops');
  const o=ops.find(x=>x.id===id);
  o.activo=!o.activo;
  s('ops',ops);
  cargarTabla();
}

function cargarTabla(){
  tablaOps.innerHTML='';
  g('ops').forEach(o=>{
    const sec=g('sectores').find(s=>s.id===o.sector).n;
    tablaOps.innerHTML+=`
      <tr>
        <td>${o.nombre}</td>
        <td>${o.usuario}</td>
        <td>${o.rol}</td>
        <td>${sec}</td>
        <td><span class="badge ${o.activo?'ok':'block'}">${o.activo?'Activo':'Bloqueado'}</span></td>
        <td><button class="gris" onclick="toggle(${o.id})">Toggle</button></td>
      </tr>`;
  });
}
cargarTabla();
</script>
</body>
</html>
