<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PARKFACIL</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#f1f5f9}
.sidebar{width:230px;background:#0f172a;color:#fff;position:fixed;height:100vh}
.sidebar h2{padding:16px;margin:0;border-bottom:1px solid #334155}
.sidebar div{padding:14px 16px;cursor:pointer}
.sidebar div:hover{background:#1e293b}
.content{margin-left:230px;padding:20px}
.card{background:#fff;padding:20px;border-radius:10px;max-width:600px}
.hidden{display:none}
input,select,button{width:100%;padding:10px;margin-top:8px}
button{border:none;border-radius:6px;color:#fff}
.azul{background:#2563eb}
.verde{background:#16a34a}
.rojo{background:#dc2626}
.gris{background:#6b7280}
.ticket{width:240px;border:1px dashed #000;padding:10px;margin-top:10px;font-size:12px}
.ticket h3{text-align:center;margin:4px}
.c{text-align:center}
table{width:100%;border-collapse:collapse;margin-top:10px}
td,th{border-bottom:1px solid #ddd;padding:6px}
</style>
</head>

<body>

<div class="sidebar">
  <h2>PARKFACIL</h2>
  <div onclick="show('login')">üîë Login</div>
  <div onclick="show('operacion')" id="mOp" class="hidden">üöó Operaci√≥n</div>
  <div onclick="show('usuarios')" id="mUsr" class="hidden">üë§ Operadores</div>
  <div onclick="logout()" id="mOut" class="hidden">‚èª Logout</div>
</div>

<div class="content">

<!-- LOGIN -->
<div id="login" class="card">
  <h3>Login</h3>
  <input id="lUser" placeholder="Usuario">
  <input id="lPass" type="password" placeholder="Clave">
  <button class="verde" onclick="login()">Ingresar</button>
  <div id="msg"></div>
</div>

<!-- OPERACION -->
<div id="operacion" class="card hidden">
  <h3>Operaci√≥n</h3>
  <div id="info"></div>

  <input id="patente" placeholder="CX-PY-95">
  <button class="azul" onclick="iniciar()">Iniciar estad√≠a</button>

  <h4>Buscar patente</h4>
  <select id="lista"></select>
  <button class="rojo" onclick="detener()">Detener estad√≠a</button>

  <div id="ticket"></div>
</div>

<!-- OPERADORES -->
<div id="usuarios" class="card hidden">
  <h3>Operadores (Empresa)</h3>
  <input id="uUser" placeholder="Usuario">
  <input id="uPass" placeholder="Clave">
  <select id="uSector">
    <option value="A">Sector A</option>
    <option value="B">Sector B</option>
  </select>
  <button class="verde" onclick="crearOperador()">Crear operador</button>

  <table>
    <thead>
      <tr><th>Usuario</th><th>Sector</th><th>Estado</th><th></th></tr>
    </thead>
    <tbody id="tabla"></tbody>
  </table>
</div>

</div>

<script>
/* ===== DATOS ===== */
const EMPRESA_ID = 'EMPRESA_1';

/* INIT */
if(!localStorage.getItem('usuarios')){
  localStorage.setItem('usuarios',JSON.stringify([{
    usuario:'admin',clave:'admin',rol:'admin',
    empresa:EMPRESA_ID,sector:'ALL',activo:true
  }]));
}

let user=null;
const U=()=>JSON.parse(localStorage.getItem('usuarios'));
const S=v=>localStorage.setItem('usuarios',JSON.stringify(v));

function show(id){
  ['login','operacion','usuarios'].forEach(x=>document.getElementById(x).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

/* LOGIN */
function login(){
  const u=U().find(x=>x.usuario===lUser.value && x.clave===lPass.value && x.activo);
  if(!u){msg.innerText='Credenciales inv√°lidas';return;}
  user=u;
  mOp.classList.remove('hidden');
  mOut.classList.remove('hidden');
  if(u.rol==='admin') mUsr.classList.remove('hidden');
  info.innerText=`Usuario: ${u.usuario} | Sector: ${u.sector}`;
  cargarPatentes();
  show('operacion');
}

/* LOGOUT */
function logout(){location.reload();}

/* OPERADORES */
function crearOperador(){
  const arr=U();
  arr.push({
    usuario:uUser.value,
    clave:uPass.value,
    rol:'operador',
    empresa:EMPRESA_ID,
    sector:uSector.value,
    activo:true
  });
  S(arr);
  cargarTabla();
}

function cargarTabla(){
  tabla.innerHTML='';
  U().filter(o=>o.rol==='operador' && o.empresa===EMPRESA_ID)
  .forEach(o=>{
    tabla.innerHTML+=`
    <tr>
      <td>${o.usuario}</td>
      <td>${o.sector}</td>
      <td>${o.activo?'Activo':'Bloqueado'}</td>
      <td><button onclick="bloq('${o.usuario}')">Bloq</button></td>
    </tr>`;
  });
}
function bloq(u){
  const arr=U();const o=arr.find(x=>x.usuario===u);
  o.activo=!o.activo;S(arr);cargarTabla();
}
cargarTabla();

/* OPERACION */
function iniciar(){
  localStorage.setItem('est_'+patente.value,JSON.stringify({
    patente:patente.value,
    empresa:EMPRESA_ID,
    sector:user.sector,
    entrada:Date.now()
  }));
  cargarPatentes();
}

function cargarPatentes(){
  lista.innerHTML='';
  Object.keys(localStorage).filter(k=>k.startsWith('est_')).forEach(k=>{
    const d=JSON.parse(localStorage.getItem(k));
    if(d.empresa===EMPRESA_ID &&
      (user.sector==='ALL'||d.sector===user.sector)){
      lista.innerHTML+=`<option value="${k}">${d.patente}</option>`;
    }
  });
}

function detener(){
  const k=lista.value;if(!k)return;
  const d=JSON.parse(localStorage.getItem(k));
  const min=Math.max(1,Math.floor((Date.now()-d.entrada)/60000));
  const total=min*30;

  const texto=`Patente ${d.patente} - Total $${total}`;
  const qr=btoa(texto).slice(0,20);

  ticket.innerHTML=`
  <div class="ticket">
    <h3>PARKFACIL</h3>
    <div class="c">Patente ${d.patente}</div>
    <div class="c">Sector ${d.sector}</div>
    <div class="c">Min ${min}</div>
    <div class="c"><b>$${total}</b></div>
    <div class="c">QR:${qr}</div>
    <hr>
    <button class="verde" onclick="wa('${texto}')">WhatsApp</button>
    <button class="azul" onclick="mail('${texto}')">Correo</button>
  </div>`;
  localStorage.removeItem(k);
  cargarPatentes();
}

/* ENV√çOS */
function wa(t){
  window.open(`https://wa.me/?text=${encodeURIComponent(t)}`);
}
function mail(t){
  window.location=`mailto:?subject=Ticket PARKFACIL&body=${encodeURIComponent(t)}`;
}
</script>
</body>
</html>
