<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PARKFACIL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f5f7fa}
.layout{display:flex;min-height:100vh}
.sidebar{width:230px;background:#0f172a;color:#fff}
.brand{padding:16px;font-size:18px;border-bottom:1px solid #334155}
.menu div{padding:14px 16px;cursor:pointer}
.menu div:hover{background:#1e293b}
.menu div.hidden{display:none}
.content{flex:1;padding:24px}
.seccion{display:none;max-width:900px}
.seccion.activa{display:block}
.card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.1)}
input,select,button{width:100%;padding:10px;margin-top:8px}
button{border:none;border-radius:6px;color:#fff;cursor:pointer}
.azul{background:#2563eb}
.verde{background:#16a34a}
.rojo{background:#dc2626}
.gris{background:#6b7280}
.badge{padding:4px 8px;border-radius:6px;font-size:12px}
.ok{background:#16a34a;color:#fff}
.block{background:#dc2626;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left}
</style>
</head>

<body>
<div class="layout">

<div class="sidebar">
  <div class="brand">PARKFACIL</div>
  <div class="menu">
    <div onclick="show('login')">üîë Login</div>
    <div id="menuOperacion" class="hidden" onclick="show('operacion')">üöó Operaci√≥n</div>
    <div id="menuOps" class="hidden" onclick="show('operadores')">üë§ Operadores</div>
  </div>
</div>

<div class="content">

<!-- ADMIN INICIAL -->
<div id="bootstrap" class="seccion">
  <div class="card">
    <h3>Crear Administrador Inicial</h3>
    <input id="bNombre" placeholder="Nombre completo">
    <input id="bUsuario" placeholder="Usuario">
    <input id="bClave" type="password" placeholder="Clave">
    <button class="verde" onclick="crearAdminInicial()">Crear administrador</button>
  </div>
</div>

<!-- LOGIN -->
<div id="login" class="seccion">
  <div class="card">
    <h3>Ingreso</h3>
    <input id="loginUser" placeholder="Usuario">
    <input id="loginPass" type="password" placeholder="Clave">
    <button class="verde" onclick="login()">Ingresar</button>
    <div id="loginMsg"></div>
  </div>
</div>

<!-- OPERACION -->
<div id="operacion" class="seccion">
  <div class="card">
    <h3>Operaci√≥n</h3>
    <div id="opInfo"></div>
    <input id="patente" placeholder="CX-PY-95">
    <button class="azul" onclick="iniciar()">Iniciar estad√≠a</button>
    <button class="rojo" onclick="detener()">Detener estad√≠a</button>
    <div id="resultado"></div>
    <div id="qr"></div>
  </div>
</div>

<!-- OPERADORES -->
<div id="operadores" class="seccion">
  <div class="card">
    <h3>Gesti√≥n de Usuarios</h3>
    <input id="opNombre" placeholder="Nombre completo">
    <input id="opUsuario" placeholder="Usuario">
    <input id="opClave" type="password" placeholder="Clave">
    <select id="opRol">
      <option value="operador">Operador</option>
      <option value="admin">Admin</option>
    </select>
    <select id="opSector"></select>
    <button class="verde" onclick="crearUsuario()">Crear usuario</button>

    <table>
      <thead>
        <tr>
          <th>Nombre</th><th>Usuario</th><th>Rol</th>
          <th>Sector</th><th>Estado</th><th></th>
        </tr>
      </thead>
      <tbody id="tablaOps"></tbody>
    </table>
  </div>
</div>

</div>
</div>

<script>
const g=k=>JSON.parse(localStorage.getItem(k)||'[]');
const s=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

if(!g('sectores').length){
  s('sectores',[{id:1,n:'Sector A'},{id:2,n:'Sector B'}]);
}

let operador=null;

// FLUJO INICIAL
if(g('ops').length===0){
  show('bootstrap');
}else{
  show('login');
}

function show(id){
  document.querySelectorAll('.seccion').forEach(x=>x.classList.remove('activa'));
  document.getElementById(id).classList.add('activa');
}

// ADMIN INICIAL
function crearAdminInicial(){
  const ops=[{
    id:Date.now(),
    nombre:bNombre.value,
    usuario:bUsuario.value,
    clave:bClave.value,
    rol:'admin',
    sector:1,
    activo:true
  }];
  s('ops',ops);
  show('login');
}

// LOGIN
function login(){
  const op=g('ops').find(o=>
    o.usuario===loginUser.value &&
    o.clave===loginPass.value &&
    o.activo
  );
  if(!op){ loginMsg.innerText='‚ùå Credenciales inv√°lidas'; return; }

  operador=op;
  menuOperacion.classList.remove('hidden');
  if(op.rol==='admin') menuOps.classList.remove('hidden');
  show('operacion');
  opInfo.innerText=`${op.nombre} | ${op.rol} | Sector ${op.sector}`;
}

// OPERACION
function iniciar(){
  if(!operador) return;
  localStorage.setItem(patente.value,JSON.stringify({
    entrada:Date.now(),sector:operador.sector,op:operador.usuario
  }));
}

function detener(){
  const d=JSON.parse(localStorage.getItem(patente.value));
  if(!d||d.sector!==operador.sector) return alert('No autorizado');
  const min=Math.max(1,Math.floor((Date.now()-d.entrada)/60000));
  resultado.innerText=`Total $${min*30}`;
  qr.innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=VALIDAR">`;
  localStorage.removeItem(patente.value);
}

// USUARIOS
function crearUsuario(){
  if(operador.rol!=='admin') return;
  const ops=g('ops');
  ops.push({
    id:Date.now(),
    nombre:opNombre.value,
    usuario:opUsuario.value,
    clave:opClave.value,
    rol:opRol.value,
    sector:+opSector.value,
    activo:true
  });
  s('ops',ops);
  cargarTabla();
}

function cargarTabla(){
  tablaOps.innerHTML='';
  g('ops').forEach(o=>{
    tablaOps.innerHTML+=`
      <tr>
        <td>${o.nombre}</td><td>${o.usuario}</td>
        <td>${o.rol}</td><td>${o.sector}</td>
        <td>${o.activo?'Activo':'Bloqueado'}</td>
        <td><button onclick="toggle(${o.id})">Toggle</button></td>
      </tr>`;
  });
}
function toggle(id){
  const ops=g('ops');
  const o=ops.find(x=>x.id===id);
  o.activo=!o.activo;
  s('ops',ops);
  cargarTabla();
}
</script>
</body>
</html>
