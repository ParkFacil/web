<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PARKFACIL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#f5f7fa}
.layout{display:flex;min-height:100vh}
.sidebar{width:220px;background:#0f172a;color:#fff}
.brand{padding:16px;font-size:18px;border-bottom:1px solid #334155}
.menu div{padding:14px 16px;cursor:pointer}
.menu div:hover{background:#1e293b}
.content{flex:1;padding:24px}
.seccion{display:none;max-width:720px}
.seccion.activa{display:block}
.card{background:#fff;padding:24px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.1)}
input,select,button{width:100%;padding:10px;margin-top:8px}
button{border:none;border-radius:6px;color:#fff;cursor:pointer}
.azul{background:#2563eb}
.rojo{background:#dc2626}
.verde{background:#16a34a}
.gris{background:#6b7280}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border-bottom:1px solid #ddd;padding:6px}
.badge{padding:4px 8px;border-radius:6px;font-size:12px;background:#16a34a;color:#fff}
.kpi{background:#e5e7eb;padding:12px;border-radius:8px;margin-bottom:8px}
.qr{margin-top:12px;text-align:center}
</style>
</head>

<body>
<div class="layout">

<div class="sidebar">
  <div class="brand">PARKFACIL</div>
  <div class="menu">
    <div onclick="show('login')">ðŸ”‘ Login</div>
    <div onclick="show('operacion')">ðŸš— OperaciÃ³n</div>
    <div onclick="show('dashboard')">ðŸ“Š Dashboard</div>
    <div onclick="show('reportes')">ðŸ“„ Reportes</div>
  </div>
</div>

<div class="content">

<!-- LOGIN -->
<div id="login" class="seccion activa">
  <div class="card">
    <h3>Operador activo</h3>
    <select id="loginSelect"></select>
    <button class="verde" onclick="login()">Ingresar</button>
    <div id="opActivo"></div>
  </div>
</div>

<!-- OPERACION -->
<div id="operacion" class="seccion">
  <div class="card">
    <h3>OperaciÃ³n</h3>
    <div id="sectorActivo" class="badge"></div>
    <input id="patente" placeholder="CX-PY-95">
    <button class="azul" onclick="iniciar()">Iniciar estadÃ­a</button>
    <button class="rojo" onclick="detener()">Detener estadÃ­a</button>
    <div id="resultado"></div>
    <div id="qr" class="qr"></div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="seccion">
  <div class="card">
    <h3>Dashboard Admin</h3>
    <div id="kpis"></div>
  </div>
</div>

<!-- REPORTES -->
<div id="reportes" class="seccion">
  <div class="card">
    <h3>Reportes por dÃ­a / sector</h3>
    <input type="date" id="fechaReporte">
    <button class="azul" onclick="generarReporte()">Generar</button>
    <div id="tablaReporte"></div>
  </div>
</div>

</div>
</div>

<script>
// HELPERS
const g=k=>JSON.parse(localStorage.getItem(k)||'[]');
const s=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const hoy=()=>new Date().toISOString().slice(0,10);

// INIT
if(!g('sectores').length){
  s('sectores',[
    {id:1,n:'Sector A'},
    {id:2,n:'Sector B'},
    {id:3,n:'SubterrÃ¡neo'}
  ]);
}
if(!g('ops').length){
  s('ops',[{id:1,n:'Admin',r:'admin',sector:1,b:false,ok:true}]);
}
let activo=null;

// NAV
function show(id){
  document.querySelectorAll('.seccion').forEach(s=>s.classList.remove('activa'));
  document.getElementById(id).classList.add('activa');
}

// LOGIN
function loadLogin(){
  loginSelect.innerHTML='';
  g('ops').filter(o=>o.ok&&!o.b).forEach(o=>{
    loginSelect.innerHTML+=`<option value="${o.id}">${o.n}</option>`;
  });
}
loadLogin();

function login(){
  activo=g('ops').find(o=>o.id==loginSelect.value);
  opActivo.innerText=`Activo: ${activo.n}`;
  sectorActivo.innerText=
    g('sectores').find(s=>s.id===activo.sector).n;
  show('operacion');
  if(activo.r==='admin') show('dashboard');
}

// OPERACION
function iniciar(){
  localStorage.setItem(patente.value,JSON.stringify({
    e:new Date().toISOString(),
    sector:activo.sector,
    op:activo.id
  }));
}
function detener(){
  const d=JSON.parse(localStorage.getItem(patente.value));
  if(!d){alert('No encontrada');return;}
  if(d.sector!==activo.sector){
    alert('No autorizado para este sector');
    return;
  }
  const min=Math.max(1,Math.floor((Date.now()-new Date(d.e))/60000));
  const total=min*30;
  let t=g('tickets');
  t.push({
    fecha:hoy(),
    sector:d.sector,
    op:d.op,
    total
  });
  s('tickets',t);
  localStorage.removeItem(patente.value);
  resultado.innerText=`Total $${total}`;

  const url=`https://parkfacil.cl/validar?patente=${patente.value}&sector=${d.sector}&fecha=${hoy()}`;
  qr.innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}">`;
}

// DASHBOARD
function loadDashboard(){
  const t=g('tickets').filter(t=>t.fecha===hoy());
  let html='';
  g('sectores').forEach(sx=>{
    const tot=t.filter(t=>t.sector===sx.id)
      .reduce((a,b)=>a+b.total,0);
    html+=`<div class="kpi">${sx.n}: $${tot}</div>`;
  });
  kpis.innerHTML=html;
}
setInterval(loadDashboard,3000);

// REPORTES
function generarReporte(){
  const f=fechaReporte.value;
  const t=g('tickets').filter(t=>t.fecha===f);
  let html='<table><tr><th>Sector</th><th>Total</th></tr>';
  g('sectores').forEach(sx=>{
    const tot=t.filter(t=>t.sector===sx.id)
      .reduce((a,b)=>a+b.total,0);
    html+=`<tr><td>${sx.n}</td><td>$${tot}</td></tr>`;
  });
  html+='</table>';
  tablaReporte.innerHTML=html;
}
</script>
</body>
</html>
